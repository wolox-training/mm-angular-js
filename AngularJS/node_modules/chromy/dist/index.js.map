{"version":3,"sources":["../src/index.js"],"names":["fs","require","CDP","chainProxy","uuidV4","devices","sharp","createFullscreenEmulationManager","TimeoutError","GotoTimeoutError","WaitTimeoutError","EvaluateTimeoutError","EvaluateError","functionToEvaluatingSource","escapeHtml","escapeSingleQuote","createChromeLauncher","completeUrl","instances","instanceId","makeSendToChromy","uuid","defaultTargetFunction","targets","filter","t","type","shift","_clone","obj","Object","assign","Chromy","options","defaults","port","waitTimeout","gotoTimeout","loadTimeout","evaluateTimeout","waitFunctionPollingInterval","typeInterval","activateOnStartUp","target","chromeFlags","cdpOptions","client","launcher","messagePrefix","emulateMode","currentEmulateDeviceName","userAgentBeforeEmulate","startingUrl","launch","push","Promise","resolve","reject","Network","Page","Runtime","Console","all","enable","_getTargetIdFromOption","targetId","Target","activateTarget","userAgent","headers","on","err","catch","e","getTargets","result","page","targetInfos","Error","close","kill","i","ua","_checkStart","setUserAgentOverride","setExtraHTTPHeaders","callback","messageAdded","payload","msg","message","text","pre","substring","length","apply","console","warn","f","defineFunction","sendToChromy","data","JSON","parse","url","defaultOptions","waitLoadEvent","_waitFinish","navigate","loadEventFired","promise","evaluate","expression","ignoreCache","scriptToEvaluateOnLoad","reload","expr","_evaluateWithReplaces","replaces","params","subtype","awaitPromise","promiseObjectId","objectId","returnByValue","value","stringify","description","resultObject","undefined","log","timeout","start","Date","now","finished","error","sleep","def","funcs","Array","isArray","_moduleToFunctionSources","toString","module","funcName","func","src","trim","msec","setTimeout","cond","_waitFunction","_waitSelector","r","selector","check","startTime","document","querySelector","characters","split","c","Input","dispatchKeyEvent","inputOptions","x","y","opts","dispatchMouseEvent","button","time","timestamp","synthesizeTapGesture","tapCount","sel","format","quality","fromSurface","indexOf","captureScreenshot","Buffer","from","model","emulation","emulate","screenshot","info","browserInfo","devicePixelRatio","s","metadata","m1","newWidth","parseInt","width","newHeight","height","resize","toBuffer","reset","getBoundingClientRect","rect","window","pixelRatio","scroll","left","top","actualRect","clipRect","Math","floor","buffer","meta","extract","selectors","useSelectorAll","screenshotDocument","fullscreenBuffer","selIdx","rects","getBoundingClientRectAll","reason","rectIdx","printToPDF","screencastFrame","screencastFrameAck","sessionId","startScreencast","stopScreencast","responseReceived","file","readFile","encoding","script","replace","style","deviceName","device","Emulation","setDeviceMetricsOverride","deviceScaleFactor","mobile","fitWindow","scale","pageScaleFactor","platform","setTouchEmulationEnabled","enabled","configuration","clearDeviceMetricsOverride","urls","setBlockedURLs","clearBrowserCache","setCookie","name","deleteCookie","cookieName","clearBrowserCookies","Memory","getDOMCounters","origin","location","Storage","clearDataForOrigin","storageTypes","dx","_1","dy","_2","scrollTo","pageXOffset","pageYOffset","dom","doms","querySelectorAll","map","copy","concat","promises","exports"],"mappings":"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","file":"index.js","sourcesContent":["const fs = require('fs')\n\nconst CDP = require('chrome-remote-interface')\nconst chainProxy = require('async-chain-proxy')\nconst uuidV4 = require('uuid/v4')\nconst devices = require('./devices')\nconst sharp = require('sharp')\nconst {createFullscreenEmulationManager} = require('./emulation')\n\nconst {\n  TimeoutError,\n  GotoTimeoutError,\n  WaitTimeoutError,\n  EvaluateTimeoutError,\n  EvaluateError\n} = require('./error')\nconst {\n  functionToEvaluatingSource\n} = require('./functionToSource')\nconst {\n  escapeHtml,\n  escapeSingleQuote,\n  createChromeLauncher,\n  completeUrl\n} = require('./util')\n\nlet instances = []\nlet instanceId = 1\n\nfunction makeSendToChromy (uuid) {\n  return `\n  function () {\n    console.info('${uuid}:' + JSON.stringify(arguments))\n  }\n  `\n}\n\nfunction defaultTargetFunction (targets) {\n  return targets.filter(t => t.type === 'page').shift()\n}\n\nconst _clone = (obj) => Object.assign({}, obj)\n\nclass Chromy {\n  constructor (options = {}) {\n    const defaults = {\n      port: 9222,\n      waitTimeout: 30000,\n      gotoTimeout: 30000,\n      loadTimeout: 30000,\n      evaluateTimeout: 30000,\n      waitFunctionPollingInterval: 100,\n      typeInterval: 20,\n      activateOnStartUp: true,\n      target: defaultTargetFunction,\n      chromeFlags: []\n    }\n    this.options = Object.assign(_clone(defaults), options)\n    this.cdpOptions = {\n      port: this.options.port,\n      target: this.options.target\n    }\n    this.client = null\n    this.launcher = null\n    this.messagePrefix = null\n    this.emulateMode = false\n    this.currentEmulateDeviceName = null\n    this.userAgentBeforeEmulate = null\n    this.instanceId = instanceId++\n  }\n\n  chain (options = {}) {\n    return chainProxy(this, options)\n  }\n\n  async start (startingUrl = null) {\n    if (startingUrl === null) {\n      startingUrl = 'about:blank'\n    }\n    if (this.client !== null) {\n      return\n    }\n    if (this.launcher === null) {\n      this.launcher = createChromeLauncher(completeUrl(startingUrl), this.options)\n    }\n    await this.launcher.launch()\n    instances.push(this)\n    await new Promise((resolve, reject) => {\n      CDP(this.cdpOptions, async (client) => {\n        try {\n          this.client = client\n          const {Network, Page, Runtime, Console} = client\n          await Promise.all([Network.enable(), Page.enable(), Runtime.enable(), Console.enable()])\n\n          // activate first tab\n          if (this.options.activateOnStartUp) {\n            let targetId = await this._getTargetIdFromOption()\n            await this.client.Target.activateTarget({targetId: targetId})\n          }\n\n          if ('userAgent' in this.options) {\n            await this.userAgent(this.options.userAgent)\n          }\n          if ('headers' in this.options) {\n            await this.headers(this.options.headers)\n          }\n          resolve(this)\n        } catch (e) {\n          reject(e)\n        }\n      }).on('error', (err) => {\n        reject(err)\n      })\n    }).catch(e => {\n      throw e\n    })\n  }\n\n  async _getTargetIdFromOption () {\n    if (typeof this.options.target === 'function') {\n      const result = await this.client.Target.getTargets()\n      const page = this.options.target(result.targetInfos)\n      return page.targetId\n    } else if (typeof this.options.target === 'object') {\n      return this.options.target.targetId\n    } else if (typeof this.options.target === 'string') {\n      return this.options.target\n    } else {\n      throw new Error('type of `target` option is invalid.')\n    }\n  }\n\n  async close () {\n    if (this.client === null) {\n      return false\n    }\n    await this.client.close()\n    this.client = null\n    if (this.launcher !== null) {\n      await this.launcher.kill()\n      this.launcher = null\n    }\n    instances = instances.filter(i => i.instanceId !== this.instanceId)\n    return true\n  }\n\n  static async cleanup () {\n    const copy = [].concat(instances)\n    const promises = copy.map(i => i.close())\n    await Promise.all(promises)\n  }\n\n  async getPageTargets () {\n    const result = await this.client.Target.getTargets()\n    return result.targetInfos.filter(t => t.type === 'page')\n  }\n\n  async userAgent (ua) {\n    await this._checkStart()\n    return await this.client.Network.setUserAgentOverride({'userAgent': ua})\n  }\n\n  /**\n   * Example:\n   * chromy.headers({'X-Requested-By': 'foo'})\n   */\n  async headers (headers) {\n    await this._checkStart()\n    return await this.client.Network.setExtraHTTPHeaders({'headers': headers})\n  }\n\n  async console (callback) {\n    await this._checkStart()\n    this.client.Console.messageAdded((payload) => {\n      try {\n        const msg = payload.message.text\n        const pre = this.messagePrefix\n        if (typeof msg !== 'undefined') {\n          if (pre === null || msg.substring(0, pre.length + 1) !== pre + ':') {\n            callback.apply(this, [msg, payload.message])\n          }\n        }\n      } catch (e) {\n        console.warn(e)\n      }\n    })\n  }\n\n  async receiveMessage (callback) {\n    await this._checkStart()\n    const uuid = uuidV4()\n    this.messagePrefix = uuid\n    const f = makeSendToChromy(this.messagePrefix)\n    this.defineFunction({sendToChromy: f})\n    this.client.Console.messageAdded((payload) => {\n      try {\n        const msg = payload.message.text\n        if (msg && msg.substring(0, uuid.length + 1) === uuid + ':') {\n          const data = JSON.parse(msg.substring(uuid.length + 1))\n          callback.apply(this, [data])\n        }\n      } catch (e) {\n        console.warn(e)\n      }\n    })\n  }\n\n  async goto (url, options) {\n    const defaultOptions = {\n      waitLoadEvent: true\n    }\n    options = Object.assign(_clone(defaultOptions), options)\n    await this._checkStart(url)\n    try {\n      await this._waitFinish(this.options.gotoTimeout, async () => {\n        await this.client.Page.navigate({url: completeUrl(url)})\n        if (options.waitLoadEvent) {\n          await this.client.Page.loadEventFired()\n        }\n      })\n    } catch (e) {\n      if (e instanceof TimeoutError) {\n        throw new GotoTimeoutError('goto() timeout')\n      } else {\n        throw e\n      }\n    }\n  }\n\n  async waitLoadEvent () {\n    await this._waitFinish(this.options.loadTimeout, async () => {\n      await this.client.Page.loadEventFired()\n    })\n  }\n\n  async forward () {\n    const f = 'window.history.forward()'\n    const promise = this.waitLoadEvent()\n    await this.client.Runtime.evaluate({expression: f})\n    await promise\n  }\n\n  async back () {\n    const f = 'window.history.back()'\n    const promise = this.waitLoadEvent()\n    await this.client.Runtime.evaluate({expression: f})\n    await promise\n  }\n\n  async reload (ignoreCache, scriptToEvaluateOnLoad) {\n    await this.client.Page.reload({ignoreCache, scriptToEvaluateOnLoad})\n  }\n\n  async evaluate (expr, options = {}) {\n    return await this._evaluateWithReplaces(expr, options)\n  }\n\n  async _evaluateWithReplaces (expr, options = {}, replaces = {}) {\n    let e = functionToEvaluatingSource(expr, replaces)\n    try {\n      let result = await this._waitFinish(this.options.evaluateTimeout, async () => {\n        if (!this.client) {\n          return null\n        }\n        let params = Object.assign({}, options, {expression: e})\n        return await this.client.Runtime.evaluate(params)\n      })\n      if (!result || !result.result) {\n        return null\n      }\n      // resolve a promise\n      if (result.result.subtype === 'promise') {\n        result = await this.client.Runtime.awaitPromise({promiseObjectId: result.result.objectId, returnByValue: true})\n        // adjust to after process\n        result.result.value = JSON.stringify({\n          type: (typeof result.result.value),\n          result: JSON.stringify(result.result.value)\n        })\n      }\n      if (result.result.subtype === 'error') {\n        throw new EvaluateError('An error has been occurred in evaluated script on a browser.' + result.result.description, result.result)\n      }\n      const resultObject = JSON.parse(result.result.value)\n      const type = resultObject.type\n      if (type === 'undefined') {\n        return undefined\n      } else {\n        try {\n          return JSON.parse(resultObject.result)\n        } catch (e) {\n          console.log('ERROR', resultObject)\n          throw e\n        }\n      }\n    } catch (e) {\n      if (e instanceof TimeoutError) {\n        throw new EvaluateTimeoutError('evaluate() timeout')\n      } else {\n        throw e\n      }\n    }\n  }\n\n  async _waitFinish (timeout, callback) {\n    const start = Date.now()\n    let finished = false\n    let error = null\n    let result = null\n    const f = async () => {\n      try {\n        result = await callback.apply()\n        finished = true\n        return result\n      } catch (e) {\n        error = e\n        finished = true\n      }\n    }\n    f.apply()\n    while (!finished) {\n      const now = Date.now()\n      if ((now - start) > timeout) {\n        throw new TimeoutError('timeout')\n      }\n      await this.sleep(this.options.waitFunctionPollingInterval)\n    }\n    if (error !== null) {\n      throw error\n    }\n    return result\n  }\n\n  /**\n   * define function\n   *\n   * @param func {(function|string|Array.<function>|Array.<string>)}\n   * @returns {Promise.<void>}\n   */\n  async defineFunction (def) {\n    let funcs = []\n    if (Array.isArray(def)) {\n      funcs = def\n    } else if ((typeof def) === 'object') {\n      funcs = this._moduleToFunctionSources(def)\n    } else {\n      funcs.push(def)\n    }\n    for (let i = 0; i < funcs.length; i++) {\n      let f = funcs[i]\n      if ((typeof f) === 'function') {\n        f = f.toString()\n      }\n      await this.client.Runtime.evaluate({expression: f})\n    }\n  }\n\n  _moduleToFunctionSources (module) {\n    const result = []\n    for (let funcName in module) {\n      let func = module[funcName]\n      let src = `function ${funcName} () { return (${func.toString()})(...arguments) }`.trim()\n      result.push(src)\n    }\n    return result\n  }\n\n  async sleep (msec) {\n    await new Promise((resolve, reject) => {\n      setTimeout(() => {\n        resolve()\n      }, msec)\n    })\n  }\n\n  async wait (cond) {\n    if ((typeof cond) === 'number') {\n      await this.sleep(cond)\n    } else if ((typeof cond) === 'function') {\n      await this._waitFunction(cond)\n    } else {\n      await this._waitSelector(cond)\n    }\n  }\n\n  // wait for func to return true.\n  async _waitFunction (func) {\n    await this._waitFinish(this.options.waitTimeout, async () => {\n      while (true) {\n        const r = await this.evaluate(func)\n        if (r) {\n          break\n        }\n        await this.sleep(this.options.waitFunctionPollingInterval)\n      }\n    })\n  }\n\n  async _waitSelector (selector) {\n    let check = null\n    let startTime = Date.now()\n    await new Promise((resolve, reject) => {\n      check = () => {\n        setTimeout(async () => {\n          try {\n            const now = Date.now()\n            if (now - startTime > this.options.waitTimeout) {\n              reject(new WaitTimeoutError('wait() timeout'))\n              return\n            }\n            const result = await this._evaluateWithReplaces(() => {\n              return document.querySelector('?')\n            }, {}, {'?': escapeSingleQuote(selector)})\n            if (result) {\n              resolve(result)\n            } else {\n              check()\n            }\n          } catch (e) {\n            reject(e)\n          }\n        }, this.options.waitFunctionPollingInterval)\n      }\n      check()\n    })\n  }\n\n  async type (expr, value) {\n    await this.evaluate('document.querySelector(\"' + expr + '\").focus()')\n    const characters = value.split('')\n    for (let i in characters) {\n      const c = characters[i]\n      await this.client.Input.dispatchKeyEvent({type: 'char', text: c})\n      await this.sleep(this.options.typeInterval)\n    }\n  }\n\n  async insert (expr, value) {\n    expr = escapeSingleQuote(expr)\n    await this.evaluate('document.querySelector(\\'' + expr + '\\').focus()')\n    await this.evaluate('document.querySelector(\\'' + expr + '\\').value = \"' + escapeHtml(value) + '\"')\n  }\n\n  async click (expr, inputOptions = {}) {\n    const defaults = {waitLoadEvent: false}\n    const options = Object.assign(_clone(defaults), inputOptions)\n    let promise = null\n    if (options.waitLoadEvent) {\n      promise = this.waitLoadEvent()\n    }\n    await this.evaluate('document.querySelectorAll(\\'' + escapeSingleQuote(expr) + '\\').forEach(n => n.click())')\n    if (promise !== null) {\n      await promise\n    }\n  }\n\n  async mouseMoved (x, y, options = {}) {\n    const opts = Object.assign({type: 'mouseMoved', x: x, y: y}, options)\n    await this.client.Input.dispatchMouseEvent(opts)\n  }\n\n  async mousePressed (x, y, options = {}) {\n    const opts = Object.assign({type: 'mousePressed', x: x, y: y, button: 'left'}, options)\n    await this.client.Input.dispatchMouseEvent(opts)\n  }\n\n  async mouseReleased (x, y, options = {}) {\n    const opts = Object.assign({type: 'mouseReleased', x: x, y: y, button: 'left'}, options)\n    await this.client.Input.dispatchMouseEvent(opts)\n  }\n\n  async tap (x, y, options = {}) {\n    const time = Date.now() / 1000\n    const opts = Object.assign({x: x, y: y, timestamp: time, button: 'left'}, options)\n    await this.client.Input.synthesizeTapGesture(opts)\n  }\n\n  async doubleTap (x, y, options = {}) {\n    const time = Date.now() / 1000\n    const opts = Object.assign({x: x, y: y, timestamp: time, button: 'left', tapCount: 2}, options)\n    await this.client.Input.synthesizeTapGesture(opts)\n  }\n\n  async check (selector) {\n    await this.evaluate('document.querySelectorAll(\\'' + escapeSingleQuote(selector) + '\\').forEach(n => n.checked = true)')\n  }\n\n  async uncheck (selector) {\n    await this.evaluate('document.querySelectorAll(\\'' + escapeSingleQuote(selector) + '\\').forEach(n => n.checked = false)')\n  }\n\n  async select (selector, value) {\n    let sel = escapeSingleQuote(selector)\n    const src = `\n      document.querySelectorAll('${sel} > option').forEach(n => {\n        if (n.value === \"${value}\") {\n          n.selected = true\n        }\n      })\n      `\n    await this.evaluate(src)\n  }\n\n  async screenshot (format = 'png', quality = undefined, fromSurface = true) {\n    if (['png', 'jpeg'].indexOf(format) === -1) {\n      throw new Error('format is invalid.')\n    }\n    const {data} = await this.client.Page.captureScreenshot({\n      format: format,\n      quality: quality,\n      fromSurface: fromSurface\n    })\n    return Buffer.from(data, 'base64')\n  }\n\n  /*\n   * Limitation:\n   * maximum height is 16384px because of chrome's bug from Skia library.\n   * https://groups.google.com/a/chromium.org/d/msg/headless-dev/DqaAEXyzvR0/kUTEqNYiDQAJ\n   * https://stackoverflow.com/questions/44599858/max-height-of-16-384px-for-headless-chrome-screenshots\n   */\n  async screenshotDocument (model = 'scroll', format = 'png', quality = undefined, fromSurface = true) {\n    const emulation = await createFullscreenEmulationManager(this, model)\n\n    let result = null\n    try {\n      await emulation.emulate()\n      result = await this.screenshot(format, quality, fromSurface)\n      const info = emulation.browserInfo\n      if (info.devicePixelRatio !== 1) {\n        let s = sharp(result)\n        let m1 = await s.metadata()\n        const newWidth = parseInt(m1.width / info.devicePixelRatio)\n        const newHeight = parseInt(m1.height / info.devicePixelRatio)\n        result = await s.resize(newWidth, newHeight).toBuffer()\n      }\n    } finally {\n      await emulation.reset()\n      // restore emulation mode\n      if (this.currentEmulateDeviceName !== null) {\n        await this.emulate(this.currentEmulateDeviceName)\n      }\n    }\n    return result\n  }\n\n  async screenshotSelector (selector, format = 'png', quality = undefined, fromSurface = true) {\n    const rect = await this.getBoundingClientRect(selector)\n    if (!rect) {\n      return null\n    }\n    const pixelRatio = await this.evaluate(function () {\n      return window.devicePixelRatio\n    })\n\n    // scroll to element\n    await this.scroll(rect.left, rect.top)\n\n    // capture screenshot and crop it.\n    const actualRect = await this.getBoundingClientRect(selector)\n    if (!actualRect) {\n      return null\n    }\n    const clipRect = {\n      top: Math.floor(actualRect.top * pixelRatio),\n      left: Math.floor(actualRect.left * pixelRatio),\n      width: Math.floor(actualRect.width * pixelRatio),\n      height: Math.floor(actualRect.height * pixelRatio)\n    }\n    const buffer = await this.screenshot(format, quality, fromSurface)\n    const meta = await sharp(buffer).metadata()\n    if (meta.width < clipRect.left + clipRect.width) {\n      clipRect.width = meta.width - clipRect.left\n    }\n    if (meta.height < clipRect.top + clipRect.height) {\n      clipRect.height = meta.height - clipRect.top\n    }\n    return sharp(buffer).extract(clipRect).toBuffer()\n  }\n\n  async screenshotMultipleSelectors (selectors, callback, options = {}) {\n    const defaults = {\n      model: 'scroll',\n      format: 'png',\n      quality: undefined,\n      fromSurface: true,\n      useSelectorAll: false\n    }\n    const opts = Object.assign({}, defaults, options)\n    const fullscreenBuffer = await this.screenshotDocument(opts.model, opts.format, opts.quality, opts.fromSurface)\n    const meta = await sharp(fullscreenBuffer).metadata()\n    const emulation = await createFullscreenEmulationManager(this, 'scroll')\n    await emulation.emulate()\n    try {\n      for (let selIdx = 0; selIdx < selectors.length; selIdx++) {\n        let selector = selectors[selIdx]\n        try {\n          let rects = null\n          if (opts.useSelectorAll) {\n            rects = await this.getBoundingClientRectAll(selector)\n          } else {\n            const r = await this.getBoundingClientRect(selector)\n            if (r) {\n              rects = [r]\n            }\n          }\n          if (rects.length === 0) {\n            const err = {reason: 'notfound', message: `selector is not found. selector=${selector}`}\n            callback.apply(this, [err, null, selIdx, selectors])\n            continue\n          }\n          for (let rectIdx = 0; rectIdx < rects.length; rectIdx++) {\n            const rect = rects[rectIdx]\n\n            if (rect.top >= meta.height || rect.left >= meta.width) {\n              const err = {reason: 'limitation', message: `top of selector is over the limitation of height. selector=${selector}`}\n              callback.apply(this, [err, null, selIdx, selectors])\n              continue\n            }\n            if (meta.width < rect.left + rect.width) {\n              rect.width = meta.width - rect.left\n            }\n            if (meta.height < rect.top + rect.height) {\n              rect.height = meta.height - rect.top\n            }\n\n            const buffer = await sharp(fullscreenBuffer).extract(rect).toBuffer()\n            callback.apply(this, [null, buffer, selIdx, selectors, rectIdx])\n          }\n        } catch (e) {\n          callback.apply(this, [e, null, selIdx, selectors])\n        }\n      }\n    } finally {\n      await emulation.reset()\n    }\n  }\n\n  async pdf (options = {}) {\n    const {data} = await this.client.Page.printToPDF(options)\n    return Buffer.from(data, 'base64')\n  }\n\n  async startScreencast (callback, options = {}) {\n    await this.client.Page.screencastFrame(async (payload) => {\n      await callback.apply(this, [payload])\n      await this.client.Page.screencastFrameAck({sessionId: payload.sessionId})\n    })\n    await this.client.Page.startScreencast(options)\n  }\n\n  async stopScreencast () {\n    await this.client.Page.stopScreencast()\n  }\n\n  async requestWillBeSent (callback) {\n    await this._checkStart()\n    await this.client.Network.responseReceived(callback)\n  }\n\n  async inject (type, file) {\n    const data = await new Promise((resolve, reject) => {\n      fs.readFile(file, {encoding: 'utf-8'}, (err, data) => {\n        if (err) reject(err)\n        resolve(data)\n      })\n    }).catch(e => {\n      throw e\n    })\n    if (type === 'js') {\n      let script = data.replace(/\\\\/g, '\\\\\\\\').replace(/'/g, '\\\\\\'').replace(/(\\r|\\n)/g, '\\\\n')\n      let expr = `\n      {\n         let script = document.createElement('script')\n         script.type = 'text/javascript'\n         script.innerHTML = '${script}'\n         document.body.appendChild(script)\n      }\n      `\n      return this.evaluate(expr)\n    } else if (type === 'css') {\n      let style = data.replace(/`/g, '\\\\`').replace(/\\\\/g, '\\\\\\\\') // .replace(/(\\r|\\n)/g, ' ')\n      let expr = `\n      {\n         let style = document.createElement('style')\n         style.type = 'text/css'\n         style.innerText = \\`\n        ${style}\n        \\`\n         document.head.appendChild(style)\n      }\n      `\n      return this.evaluate(expr)\n    } else {\n      throw new Error('found invalid type.')\n    }\n  }\n\n  async emulate (deviceName) {\n    await this._checkStart()\n\n    if (!this.emulateMode) {\n      this.userAgentBeforeEmulate = await this.evaluate('return navigator.userAgent')\n    }\n    const device = devices[deviceName]\n    await this.client.Emulation.setDeviceMetricsOverride({\n      width: device.width,\n      height: device.height,\n      deviceScaleFactor: device.deviceScaleFactor,\n      mobile: device.mobile,\n      fitWindow: false,\n      scale: device.pageScaleFactor\n    })\n    const platform = device.mobile ? 'mobile' : 'desktop'\n    await this.client.Emulation.setTouchEmulationEnabled({enabled: true, configuration: platform})\n    await this.userAgent(device.userAgent)\n    this.currentEmulateDeviceName = deviceName\n    this.emulateMode = true\n  }\n\n  async clearEmulate () {\n    await this.client.Emulation.clearDeviceMetricsOverride()\n    await this.client.Emulation.setTouchEmulationEnabled({enabled: false})\n    if (this.userAgentBeforeEmulate) {\n      await this.userAgent(this.userAgentBeforeEmulate)\n    }\n    this.emulateMode = false\n    this.currentEmulateDeviceName = null\n  }\n\n  async blockUrls (urls) {\n    await this._checkStart()\n    await this.client.Network.setBlockedURLs({urls: urls})\n  }\n\n  async clearBrowserCache () {\n    await this._checkStart()\n    await this.client.Network.clearBrowserCache()\n  }\n\n  async setCookie (params) {\n    await this._checkStart()\n    await this.client.Network.setCookie(params)\n  }\n\n  async deleteCookie (name, url) {\n    await this._checkStart()\n    await this.client.Network.deleteCookie({cookieName: name, url: url})\n  }\n\n  async clearAllCookies () {\n    await this._checkStart()\n    await this.client.Network.clearBrowserCookies()\n  }\n\n  async getDOMCounters () {\n    return await this.client.Memory.getDOMCounters()\n  }\n\n  async clearDataForOrigin (origin = null, type = 'all') {\n    if (origin === null) {\n      origin = await this.evaluate(_ => { return location.origin })\n    }\n    return await this.client.Storage.clearDataForOrigin({origin: origin, storageTypes: type})\n  }\n\n  async scroll (x, y) {\n    return this._evaluateWithReplaces(function () {\n      const dx = _1  // eslint-disable-line no-undef\n      const dy = _2  // eslint-disable-line no-undef\n      window.scrollTo(window.pageXOffset + dx, window.pageYOffset + dy)\n    }, {}, {'_1': x, '_2': y})\n  }\n\n  async scrollTo (x, y) {\n    return this._evaluateWithReplaces(function () {\n      window.scrollTo(_1, _2) // eslint-disable-line no-undef\n    }, {}, {'_1': x, '_2': y})\n  }\n\n  async getBoundingClientRect (selector) {\n    const rect = await this._evaluateWithReplaces(function () {\n      let dom = document.querySelector('?')\n      if (!dom) {\n        return null\n      }\n      let r = dom.getBoundingClientRect()\n      return {top: r.top, left: r.left, width: r.width, height: r.height}\n    }, {}, {'?': escapeSingleQuote(selector)})\n    if (!rect) {\n      return null\n    }\n    return {\n      top: Math.floor(rect.top),\n      left: Math.floor(rect.left),\n      width: Math.floor(rect.width),\n      height: Math.floor(rect.height)\n    }\n  }\n\n  async getBoundingClientRectAll (selector) {\n    const rects = await this._evaluateWithReplaces(function () {\n      let doms = document.querySelectorAll('?')\n      return doms.map(dom => {\n        let r = dom.getBoundingClientRect()\n        return {top: r.top, left: r.left, width: r.width, height: r.height}\n      })\n    }, {}, {'?': escapeSingleQuote(selector)})\n    return rects.map(rect => {\n      return {\n        top: Math.floor(rect.top),\n        left: Math.floor(rect.left),\n        width: Math.floor(rect.width),\n        height: Math.floor(rect.height)\n      }\n    })\n  }\n\n  async _checkStart (startingUrl = null) {\n    if (this.client === null) {\n      await this.start(startingUrl)\n    }\n  }\n\n}\n\nmodule.exports = Chromy\n\n"]}