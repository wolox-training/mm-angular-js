{"version":3,"sources":["../src/document.js"],"names":["fs","require","chainProxy","uuidV4","devices","sharp","ChromyDOM","ChromyNode","TimeoutError","GotoTimeoutError","WaitTimeoutError","EvaluateTimeoutError","EvaluateError","functionToEvaluatingSource","escapeHtml","escapeSingleQuote","createChromeLauncher","completeUrl","Document","client","node","options","target","Target","getTargets","result","page","targetInfos","targetId","Error","timeout","callback","start","Date","now","finished","error","f","apply","sleep","waitFunctionPollingInterval","selector","nodeId","id","DOM","getDocument","doc","root","querySelector","console","log","expr","_evaluateWithReplaces","replaces","e","_waitFinish","evaluateTimeout","params","Object","assign","expression","Runtime","evaluate","subtype","awaitPromise","promiseObjectId","objectId","returnByValue","value","JSON","stringify","type","description","resultObject","parse","undefined","def","funcs","Array","isArray","_moduleToFunctionSources","push","i","length","toString","module","funcName","func","src","trim","msec","Promise","resolve","reject","setTimeout","cond","_waitFunction","_waitSelector","waitTimeout","r","check","startTime","document","characters","split","c","Input","dispatchKeyEvent","text","typeInterval","inputOptions","defaults","waitLoadEvent","promise","dom","querySelectorAll","nodes","sel","x","y","dx","_1","dy","_2","window","scrollTo","pageXOffset","pageYOffset","rect","getBoundingClientRect","top","left","width","height","Math","floor","exports"],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA,IAAMA,KAAKC,QAAQ,IAAR,CAAX;;AAEA,IAAMC,aAAaD,QAAQ,mBAAR,CAAnB;AACA,IAAME,SAASF,QAAQ,SAAR,CAAf;AACA,IAAMG,UAAUH,QAAQ,WAAR,CAAhB;AACA,IAAMI,QAAQJ,QAAQ,OAAR,CAAd;AACA,IAAMK,YAAYL,QAAQ,OAAR,CAAlB;AACA,IAAMM,aAAaN,QAAQ,QAAR,CAAnB;;eAQIA,QAAQ,SAAR,C;IALFO,Y,YAAAA,Y;IACAC,gB,YAAAA,gB;IACAC,gB,YAAAA,gB;IACAC,oB,YAAAA,oB;IACAC,a,YAAAA,a;;gBAIEX,QAAQ,oBAAR,C;IADFY,0B,aAAAA,0B;;gBAOEZ,QAAQ,QAAR,C;IAJFa,U,aAAAA,U;IACAC,iB,aAAAA,iB;IACAC,oB,aAAAA,oB;IACAC,W,aAAAA,W;;IAGIC,Q;AACJ,sBAAyC;AAAA,QAA5BC,MAA4B,uEAAnB,IAAmB;AAAA,QAAbC,IAAa,uEAAN,IAAM;AAAA;;AACvC,SAAKD,MAAL,GAAcA,MAAd;AACA,SAAKC,IAAL,GAAYA,IAAZ;AACD;;;;4BAEoB;AAAA,UAAdC,OAAc,uEAAJ,EAAI;;AACnB,aAAOnB,WAAW,IAAX,EAAiBmB,OAAjB,CAAP;AACD;;;;;;;;;oBAGK,OAAO,KAAKA,OAAL,CAAaC,MAApB,KAA+B,U;;;;;;iDACZ,KAAKH,MAAL,CAAYI,MAAZ,CAAmBC,UAAnB,E;;;AAAfC,oB;AACAC,kB,GAAO,KAAKL,OAAL,CAAaC,MAAb,CAAoBG,OAAOE,WAA3B,C;+CACND,KAAKE,Q;;;oBACH,sBAAO,KAAKP,OAAL,CAAaC,MAApB,MAA+B,Q;;;;;+CACjC,KAAKD,OAAL,CAAaC,MAAb,CAAoBM,Q;;;oBAClB,OAAO,KAAKP,OAAL,CAAaC,MAApB,KAA+B,Q;;;;;+CACjC,KAAKD,OAAL,CAAaC,M;;;oBAEd,IAAIO,KAAJ,CAAU,qCAAV,C;;;;;;;;;;;gCAISC,O,EAASC,Q;;;;;;;;AACpBC,mB,GAAQC,KAAKC,GAAL,E;AACVC,sB,GAAW,K;AACXC,mB,GAAQ,I;AACRX,oB,GAAS,I;;AACPY,e,GAAI;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,2DAESN,SAASO,KAAT,EAFT;;AAAA;AAENb,8BAFM;;AAGNU,mCAAW,IAAX;AAHM,0DAICV,MAJD;;AAAA;AAAA;AAAA;;AAMNW;AACAD,mCAAW,IAAX;;AAPM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,e;;AAUVE,gBAAEC,KAAF;;;kBACQH,Q;;;;;AACAD,iB,GAAMD,KAAKC,GAAL,E;;oBACPA,MAAMF,KAAP,GAAgBF,O;;;;;oBACZ,IAAItB,YAAJ,CAAiB,SAAjB,C;;;;iDAEF,KAAK+B,KAAL,CAAW,KAAKlB,OAAL,CAAamB,2BAAxB,C;;;;;;;oBAEJJ,UAAU,I;;;;;oBACNA,K;;;gDAEDX,M;;;;;;;;;;;2BAGKgB,Q;;;;;;AACRC,oB,GAAS,I;;mBACT,KAAKtB,I;;;;;AACPsB,uBAAS,KAAKtB,IAAL,CAAUuB,EAAnB;;;;;;iDAEkB,KAAKxB,MAAL,CAAYyB,GAAZ,CAAgBC,WAAhB,E;;;AAAZC,iB;;AACNJ,uBAASI,IAAIC,IAAJ,CAASL,MAAlB;;;;iDAEmB,KAAKvB,MAAL,CAAYyB,GAAZ,CAAgBI,aAAhB,CAA8B,EAACP,kBAAD,EAAWC,cAAX,EAA9B,C;;;AAAfjB,oB;;kBACDA,M;;;;;gDACI,I;;;AAETwB,sBAAQC,GAAR,CAAYzB,MAAZ;gDACO,IAAIP,QAAJ,CAAa,KAAKC,MAAlB,EAA0BM,OAAOiB,MAAjC,C;;;;;;;;;;;6BAGOS,I;UAAM9B,O,uEAAU,E;;;;;;iDACjB,KAAK+B,qBAAL,CAA2BD,IAA3B,EAAiC9B,OAAjC,C;;;;;;;;;;;;;;0CAGc8B,I;;;UAAM9B,O,uEAAU,E;UAAIgC,Q,uEAAW,E;;;;;;AACtDC,e,GAAIzC,2BAA2BsC,IAA3B,EAAiCE,QAAjC,C;;;iDAEa,KAAKE,WAAL,CAAiB,KAAKlC,OAAL,CAAamC,eAA9B,EAA+C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,4BAC3D,OAAKrC,MADsD;AAAA;AAAA;AAAA;;AAAA,0DAEvD,IAFuD;;AAAA;AAI5DsC,8BAJ4D,GAInDC,OAAOC,MAAP,CAAc,EAAd,EAAkBtC,OAAlB,EAA2B,EAACuC,YAAYN,CAAb,EAA3B,CAJmD;AAAA;AAAA,2DAKnD,OAAKnC,MAAL,CAAY0C,OAAZ,CAAoBC,QAApB,CAA6BL,MAA7B,CALmD;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAA/C,C;;;AAAfhC,oB;;oBAOA,CAACA,MAAD,IAAW,CAACA,OAAOA,M;;;;;gDACd,I;;;oBAGLA,OAAOA,MAAP,CAAcsC,OAAd,KAA0B,S;;;;;;iDACb,KAAK5C,MAAL,CAAY0C,OAAZ,CAAoBG,YAApB,CAAiC,EAACC,iBAAiBxC,OAAOA,MAAP,CAAcyC,QAAhC,EAA0CC,eAAe,IAAzD,EAAjC,C;;;AAAf1C,oB;;AACA;AACAA,qBAAOA,MAAP,CAAc2C,KAAd,GAAsBC,KAAKC,SAAL,CAAe,EAACC,4BAAc9C,OAAOA,MAAP,CAAc2C,KAA5B,CAAD,EAAqC3C,QAAQ4C,KAAKC,SAAL,CAAe7C,OAAOA,MAAP,CAAc2C,KAA7B,CAA7C,EAAf,CAAtB;;;oBAEE3C,OAAOA,MAAP,CAAcsC,OAAd,KAA0B,O;;;;;oBACtB,IAAInD,aAAJ,CAAkB,iEAAiEa,OAAOA,MAAP,CAAc+C,WAAjG,EAA8G/C,OAAOA,MAArH,C;;;AAEFgD,0B,GAAeJ,KAAKK,KAAL,CAAWjD,OAAOA,MAAP,CAAc2C,KAAzB,C;AACfG,kB,GAAOE,aAAaF,I;;oBACtBA,SAAS,W;;;;;gDACJI,S;;;;gDAGEN,KAAKK,KAAL,CAAWD,aAAahD,MAAxB,C;;;;;;AAEPwB,sBAAQC,GAAR,CAAY,OAAZ,EAAqBuB,YAArB;;;;;;;;;;;oBAKA,wBAAajE,Y;;;;;oBACT,IAAIG,oBAAJ,CAAyB,oBAAzB,C;;;;;;;;;;;;;AAOZ;;;;;;;;;mCAMsBiE,G;;;;;;AAChBC,mB,GAAQ,E;;AACZ,kBAAIC,MAAMC,OAAN,CAAcH,GAAd,CAAJ,EAAwB;AACtBC,wBAAQD,GAAR;AACD,eAFD,MAEO,IAAI,QAAQA,GAAR,uDAAQA,GAAR,OAAiB,QAArB,EAA+B;AACpCC,wBAAQ,KAAKG,wBAAL,CAA8BJ,GAA9B,CAAR;AACD,eAFM,MAEA;AACLC,sBAAMI,IAAN,CAAWL,GAAX;AACD;AACQM,e,GAAI,C;;;oBAAGA,IAAIL,MAAMM,M;;;;;AACpB9C,e,GAAIwC,MAAMK,CAAN,C;;AACR,kBAAK,OAAO7C,CAAR,KAAe,UAAnB,EAA+B;AAC7BA,oBAAIA,EAAE+C,QAAF,EAAJ;AACD;;iDACK,KAAKjE,MAAL,CAAY0C,OAAZ,CAAoBC,QAApB,CAA6B,EAACF,YAAYvB,CAAb,EAA7B,C;;;AAL0B6C,iB;;;;;;;;;;;;;6CASVG,M,EAAQ;AAChC,UAAM5D,SAAS,EAAf;AACA,WAAK,IAAI6D,QAAT,IAAqBD,MAArB,EAA6B;AAC3B,YAAIE,OAAOF,OAAOC,QAAP,CAAX;AACA,YAAIE,MAAM,eAAYF,QAAZ,sBAAqCC,KAAKH,QAAL,EAArC,wBAAwEK,IAAxE,EAAV;AACAhE,eAAOwD,IAAP,CAAYO,GAAZ;AACD;AACD,aAAO/D,MAAP;AACD;;;0BAEYiE,I;;;;;;iDACL,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACrCC,2BAAW,YAAM;AACfF;AACD,iBAFD,EAEGF,IAFH;AAGD,eAJK,C;;;;;;;;;;;yBAOIK,I;;;;;oBACL,OAAOA,IAAR,KAAkB,Q;;;;;;iDACd,KAAKxD,KAAL,CAAWwD,IAAX,C;;;;;;;oBACI,OAAOA,IAAR,KAAkB,U;;;;;;iDACrB,KAAKC,aAAL,CAAmBD,IAAnB,C;;;;;;;;iDAEA,KAAKE,aAAL,CAAmBF,IAAnB,C;;;;;;;;;;AAIV;;;;kCACqBR,I;;;;;;;;iDACb,KAAKhC,WAAL,CAAiB,KAAKlC,OAAL,CAAa6E,WAA9B,EAA2C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,6BACxC,IADwC;AAAA;AAAA;AAAA;;AAAA;AAAA,2DAE7B,OAAKpC,QAAL,CAAcyB,IAAd,CAF6B;;AAAA;AAEvCY,yBAFuC;;AAAA,6BAGzCA,CAHyC;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA;AAAA,2DAMvC,OAAK5D,KAAL,CAAW,OAAKlB,OAAL,CAAamB,2BAAxB,CANuC;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,eAA3C,C;;;;;;;;;;;kCAWaC,Q;;;;;;;;;AACf2D,oB,GAAQ,I;AACRC,uB,GAAYpE,KAAKC,GAAL,E;;iDACV,IAAIyD,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACrCO,yBAAQ,iBAAM;AACZN,6BAAW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAED5D,+BAFC,GAEKD,KAAKC,GAAL,EAFL;;AAAA,kCAGHA,MAAMmE,SAAN,GAAkB,OAAKhF,OAAL,CAAa6E,WAH5B;AAAA;AAAA;AAAA;;AAILL,mCAAO,IAAInF,gBAAJ,CAAqB,gBAArB,CAAP;AAJK;;AAAA;AAAA;AAAA,+DAOc,OAAK0C,qBAAL,CAA2B,YAAM;AACpD,qCAAOkD,SAAStD,aAAT,CAAuB,GAAvB,CAAP;AACD,6BAFoB,EAElB,EAFkB,EAEd,EAAC,KAAKjC,kBAAkB0B,QAAlB,CAAN,EAFc,CAPd;;AAAA;AAODhB,kCAPC;;AAUP,gCAAIA,MAAJ,EAAY;AACVmE,sCAAQnE,MAAR;AACD,6BAFD,MAEO;AACL2E;AACD;AAdM;AAAA;;AAAA;AAAA;AAAA;;AAgBPP;;AAhBO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAAX,EAkBG,OAAKxE,OAAL,CAAamB,2BAlBhB;AAmBD,iBApBD;AAqBA4D;AACD,eAvBK,C;;;;;;;;;;;yBA0BIjD,I,EAAMiB,K;;;;;;;iDACV,KAAKN,QAAL,CAAc,6BAA6BX,IAA7B,GAAoC,YAAlD,C;;;AACAoD,wB,GAAanC,MAAMoC,KAAN,CAAY,EAAZ,C;yDACLD,U;;;;;;;;AAALrB,e;AACDuB,e,GAAIF,WAAWrB,CAAX,C;;iDACJ,KAAK/D,MAAL,CAAYuF,KAAZ,CAAkBC,gBAAlB,CAAmC,EAACpC,MAAM,MAAP,EAAeqC,MAAMH,CAArB,EAAnC,C;;;;iDACA,KAAKlE,KAAL,CAAW,KAAKlB,OAAL,CAAawF,YAAxB,C;;;;;;;;;;;;;;;2BAII1D,I,EAAMiB,K;;;;;AAClBjB,qBAAOpC,kBAAkBoC,IAAlB,CAAP;;iDACM,KAAKW,QAAL,CAAc,8BAA8BX,IAA9B,GAAqC,aAAnD,C;;;;iDACA,KAAKW,QAAL,CAAc,8BAA8BX,IAA9B,GAAqC,eAArC,GAAuDrC,WAAWsD,KAAX,CAAvD,GAA2E,GAAzF,C;;;;;;;;;;;0BAGKjB,I;UAAM2D,Y,uEAAe,E;;;;;;AAC1BC,sB,GAAW,EAACC,eAAe,KAAhB,E;AACX3F,qB,GAAUqC,OAAOC,MAAP,CAAc,EAAd,EAAkBoD,QAAlB,EAA4BD,YAA5B,C;AACZG,qB,GAAU,I;;AACd,kBAAI5F,QAAQ2F,aAAZ,EAA2B;AACzBC,0BAAU,KAAKD,aAAL,EAAV;AACD;AACKE,iB,GAAM,IAAI5G,SAAJ,CAAc,KAAKa,MAAnB,C;;iDACQ+F,IAAIC,gBAAJ,CAAqBhE,IAArB,C;;;AAAdiE,mB;yDACQA,K;;;;;;;;AAALlC,e;AACH9D,kB,GAAOgG,MAAMlC,CAAN,C;;iDACL9D,KAAK0C,QAAL,CAAc,cAAd,C;;;;;;;oBAEJmD,YAAY,I;;;;;;iDACRA,O;;;;;;;;;;;0BAIGxE,Q;;;;;;iDACL,KAAKqB,QAAL,CAAc,iCAAiC/C,kBAAkB0B,QAAlB,CAAjC,GAA+D,oCAA7E,C;;;;;;;;;;;4BAGOA,Q;;;;;;iDACP,KAAKqB,QAAL,CAAc,iCAAiC/C,kBAAkB0B,QAAlB,CAAjC,GAA+D,qCAA7E,C;;;;;;;;;;;2BAGMA,Q,EAAU2B,K;;;;;;AAClBiD,iB,GAAMtG,kBAAkB0B,QAAlB,C;AACJ+C,iB,4CACyB6B,G,8DACRjD,K;;iDAKjB,KAAKN,QAAL,CAAc0B,GAAd,C;;;;;;;;;;;2BAGM8B,C,EAAGC,C;;;;;iDACR,KAAKnE,qBAAL,CAA2B,YAAY;AAC5C,oBAAMoE,KAAKC,EAAX,CAD4C,CAC7B;AACf,oBAAMC,KAAKC,EAAX,CAF4C,CAE7B;AACfC,uBAAOC,QAAP,CAAgBD,OAAOE,WAAP,GAAqBN,EAArC,EAAyCI,OAAOG,WAAP,GAAqBL,EAA9D;AACD,eAJM,EAIJ,EAJI,EAIA,EAAC,MAAMJ,CAAP,EAAU,MAAMC,CAAhB,EAJA,C;;;;;;;;;;;6BAOOD,C,EAAGC,C;;;;;iDACV,KAAKnE,qBAAL,CAA2B,YAAY;AAC5CwE,uBAAOC,QAAP,CAAgBJ,EAAhB,EAAoBE,EAApB,EAD4C,CACpB;AACzB,eAFM,EAEJ,EAFI,EAEA,EAAC,MAAML,CAAP,EAAU,MAAMC,CAAhB,EAFA,C;;;;;;;;;;;0CAKoB9E,Q;;;;;;;iDACN,KAAKW,qBAAL,CAA2B,YAAY;AAC1D,oBAAI8D,MAAMZ,SAAStD,aAAT,CAAuB,GAAvB,CAAV;AACA,oBAAI,CAACkE,GAAL,EAAU;AACR,yBAAO,IAAP;AACD;AACD,oBAAIc,OAAOd,IAAIe,qBAAJ,EAAX;AACA,uBAAO;AACLD,wBAAM,EAACE,KAAKF,KAAKE,GAAX,EAAgBC,MAAMH,KAAKG,IAA3B,EAAiCC,OAAOJ,KAAKI,KAA7C,EAAoDC,QAAQL,KAAKK,MAAjE;AADD,iBAAP;AAGD,eAToB,EASlB,EATkB,EASd,EAAC,KAAKtH,kBAAkB0B,QAAlB,CAAN,EATc,C;;;AAAfhB,oB;;kBAUDA,M;;;;;iDACI,I;;;iDAEF;AACLyG,qBAAKI,KAAKC,KAAL,CAAW9G,OAAOuG,IAAP,CAAYE,GAAvB,CADA;AAELC,sBAAMG,KAAKC,KAAL,CAAW9G,OAAOuG,IAAP,CAAYG,IAAvB,CAFD;AAGLC,uBAAOE,KAAKC,KAAL,CAAW9G,OAAOuG,IAAP,CAAYI,KAAvB,CAHF;AAILC,wBAAQC,KAAKC,KAAL,CAAW9G,OAAOuG,IAAP,CAAYK,MAAvB;AAJH,e;;;;;;;;;;;;;AASXhD,OAAOmD,OAAP,GAAiBtH,QAAjB","file":"document.js","sourcesContent":["const fs = require('fs')\n\nconst chainProxy = require('async-chain-proxy')\nconst uuidV4 = require('uuid/v4')\nconst devices = require('./devices')\nconst sharp = require('sharp')\nconst ChromyDOM = require('./dom')\nconst ChromyNode = require('./node')\n\nconst {\n  TimeoutError,\n  GotoTimeoutError,\n  WaitTimeoutError,\n  EvaluateTimeoutError,\n  EvaluateError\n} = require('./error')\nconst {\n  functionToEvaluatingSource\n} = require('./functionToSource')\nconst {\n  escapeHtml,\n  escapeSingleQuote,\n  createChromeLauncher,\n  completeUrl\n} = require('./util')\n\nclass Document {\n  constructor (client = null, node = null) {\n    this.client = client \n    this.node = node\n  }\n\n  chain (options = {}) {\n    return chainProxy(this, options)\n  }\n\n  async _getTargetIdFromOption () {\n    if (typeof this.options.target === 'function') {\n      const result = await this.client.Target.getTargets()\n      const page = this.options.target(result.targetInfos)\n      return page.targetId\n    } else if (typeof this.options.target === 'object') {\n      return this.options.target.targetId\n    } else if (typeof this.options.target === 'string') {\n      return this.options.target\n    } else {\n      throw new Error('type of `target` option is invalid.')\n    }\n  }\n\n  async _waitFinish (timeout, callback) {\n    const start = Date.now()\n    let finished = false\n    let error = null\n    let result = null\n    const f = async () => {\n      try {\n        result = await callback.apply()\n        finished = true\n        return result\n      } catch (e) {\n        error = e\n        finished = true\n      }\n    }\n    f.apply()\n    while (!finished) {\n      const now = Date.now()\n      if ((now - start) > timeout) {\n        throw new TimeoutError('timeout')\n      }\n      await this.sleep(this.options.waitFunctionPollingInterval)\n    }\n    if (error !== null) {\n      throw error\n    }\n    return result\n  }\n\n  async iframe (selector) {\n    let nodeId = null\n    if (this.node) {\n      nodeId = this.node.id\n    } else {\n      const doc = await this.client.DOM.getDocument()\n      nodeId = doc.root.nodeId\n    }\n    const result = await this.client.DOM.querySelector({selector, nodeId})\n    if (!result) {\n      return null\n    }\n    console.log(result)\n    return new Document(this.client, result.nodeId)\n  }\n\n  async evaluate (expr, options = {}) {\n    return await this._evaluateWithReplaces(expr, options)\n  }\n\n  async _evaluateWithReplaces (expr, options = {}, replaces = {}) {\n    let e = functionToEvaluatingSource(expr, replaces)\n    try {\n      let result = await this._waitFinish(this.options.evaluateTimeout, async () => {\n        if (!this.client) {\n          return null\n        }\n        let params = Object.assign({}, options, {expression: e})\n        return await this.client.Runtime.evaluate(params)\n      })\n      if (!result || !result.result) {\n        return null\n      }\n      // resolve a promise\n      if (result.result.subtype === 'promise') {\n        result = await this.client.Runtime.awaitPromise({promiseObjectId: result.result.objectId, returnByValue: true})\n        // adjust to after process\n        result.result.value = JSON.stringify({type: (typeof result.result.value), result: JSON.stringify(result.result.value)})\n      }\n      if (result.result.subtype === 'error') {\n        throw new EvaluateError('An error has been occurred in evaluated script on a browser.' + result.result.description, result.result)\n      }\n      const resultObject = JSON.parse(result.result.value)\n      const type = resultObject.type\n      if (type === 'undefined') {\n        return undefined\n      } else {\n        try {\n          return JSON.parse(resultObject.result)\n        } catch (e) {\n          console.log('ERROR', resultObject)\n          throw e\n        }\n      }\n    } catch (e) {\n      if (e instanceof TimeoutError) {\n        throw new EvaluateTimeoutError('evaluate() timeout')\n      } else {\n        throw e\n      }\n    }\n  }\n\n  /**\n   * define function\n   *\n   * @param func {(function|string|Array.<function>|Array.<string>)}\n   * @returns {Promise.<void>}\n   */\n  async defineFunction (def) {\n    let funcs = []\n    if (Array.isArray(def)) {\n      funcs = def\n    } else if ((typeof def) === 'object') {\n      funcs = this._moduleToFunctionSources(def)\n    } else {\n      funcs.push(def)\n    }\n    for (let i = 0; i < funcs.length; i++) {\n      let f = funcs[i]\n      if ((typeof f) === 'function') {\n        f = f.toString()\n      }\n      await this.client.Runtime.evaluate({expression: f})\n    }\n  }\n\n  _moduleToFunctionSources (module) {\n    const result = []\n    for (let funcName in module) {\n      let func = module[funcName]\n      let src = `function ${funcName} () { return (${func.toString()})(...arguments) }`.trim()\n      result.push(src)\n    }\n    return result\n  }\n  \n  async sleep (msec) {\n    await new Promise((resolve, reject) => {\n      setTimeout(() => {\n        resolve()\n      }, msec)\n    })\n  }\n\n  async wait (cond) {\n    if ((typeof cond) === 'number') {\n      await this.sleep(cond)\n    } else if ((typeof cond) === 'function') {\n      await this._waitFunction(cond)\n    } else {\n      await this._waitSelector(cond)\n    }\n  }\n\n  // wait for func to return true.\n  async _waitFunction (func) {\n    await this._waitFinish(this.options.waitTimeout, async () => {\n      while (true) {\n        const r = await this.evaluate(func)\n        if (r) {\n          break\n        }\n        await this.sleep(this.options.waitFunctionPollingInterval)\n      }\n    })\n  }\n\n  async _waitSelector (selector) {\n    let check = null\n    let startTime = Date.now()\n    await new Promise((resolve, reject) => {\n      check = () => {\n        setTimeout(async () => {\n          try {\n            const now = Date.now()\n            if (now - startTime > this.options.waitTimeout) {\n              reject(new WaitTimeoutError('wait() timeout'))\n              return\n            }\n            const result = await this._evaluateWithReplaces(() => {\n              return document.querySelector('?')\n            }, {}, {'?': escapeSingleQuote(selector)})\n            if (result) {\n              resolve(result)\n            } else {\n              check()\n            }\n          } catch (e) {\n            reject(e)\n          }\n        }, this.options.waitFunctionPollingInterval)\n      }\n      check()\n    })\n  }\n\n  async type (expr, value) {\n    await this.evaluate('document.querySelector(\"' + expr + '\").focus()')\n    const characters = value.split('')\n    for (let i in characters) {\n      const c = characters[i]\n      await this.client.Input.dispatchKeyEvent({type: 'char', text: c})\n      await this.sleep(this.options.typeInterval)\n    }\n  }\n\n  async insert (expr, value) {\n    expr = escapeSingleQuote(expr)\n    await this.evaluate('document.querySelector(\\'' + expr + '\\').focus()')\n    await this.evaluate('document.querySelector(\\'' + expr + '\\').value = \"' + escapeHtml(value) + '\"')\n  }\n\n  async click (expr, inputOptions = {}) {\n    const defaults = {waitLoadEvent: false}\n    const options = Object.assign({}, defaults, inputOptions)\n    let promise = null\n    if (options.waitLoadEvent) {\n      promise = this.waitLoadEvent()\n    }\n    const dom = new ChromyDOM(this.client)\n    const nodes = await dom.querySelectorAll(expr)\n    for (let i in nodes) {\n      let node = nodes[i]\n      await node.evaluate('this.click()')\n    }\n    if (promise !== null) {\n      await promise\n    }\n  }\n\n  async check (selector) {\n    await this.evaluate('document.querySelectorAll(\\'' + escapeSingleQuote(selector) + '\\').forEach(n => n.checked = true)')\n  }\n\n  async uncheck (selector) {\n    await this.evaluate('document.querySelectorAll(\\'' + escapeSingleQuote(selector) + '\\').forEach(n => n.checked = false)')\n  }\n\n  async select (selector, value) {\n    let sel = escapeSingleQuote(selector)\n    const src = `\n      document.querySelectorAll('${sel} > option').forEach(n => {\n        if (n.value === \"${value}\") {\n          n.selected = true\n        }\n      })\n      `\n    await this.evaluate(src)\n  }\n\n  async scroll (x, y) {\n    return this._evaluateWithReplaces(function () {\n      const dx = _1  // eslint-disable-line no-undef\n      const dy = _2  // eslint-disable-line no-undef\n      window.scrollTo(window.pageXOffset + dx, window.pageYOffset + dy)\n    }, {}, {'_1': x, '_2': y})\n  }\n\n  async scrollTo (x, y) {\n    return this._evaluateWithReplaces(function () {\n      window.scrollTo(_1, _2) // eslint-disable-line no-undef\n    }, {}, {'_1': x, '_2': y})\n  }\n\n  async getBoundingClientRect (selector) {\n    const result = await this._evaluateWithReplaces(function () {\n      let dom = document.querySelector('?')\n      if (!dom) {\n        return null\n      }\n      let rect = dom.getBoundingClientRect()\n      return {\n        rect: {top: rect.top, left: rect.left, width: rect.width, height: rect.height}\n      }\n    }, {}, {'?': escapeSingleQuote(selector)})\n    if (!result) {\n      return null\n    }\n    return {\n      top: Math.floor(result.rect.top),\n      left: Math.floor(result.rect.left),\n      width: Math.floor(result.rect.width),\n      height: Math.floor(result.rect.height)\n    }\n  }\n}\n\nmodule.exports = Document\n\n"]}